<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API Test - Debug</title>
    <style>
        body {
            font-family: monospace;
            padding: 20px;
            max-width: 800px;
            margin: auto;
            background: #f5f5f5;
        }
        
        h1 {
            color: #333;
        }
        
        .test-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .test-btn {
            background: #2563eb;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
        }
        
        .test-btn:hover {
            background: #1e40af;
        }
        
        .result {
            background: #f0f0f0;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-size: 12px;
        }
        
        .success {
            background: #d4edda;
            color: #155724;
        }
        
        .error {
            background: #f8d7da;
            color: #721c24;
        }
        
        .info {
            background: #d1ecf1;
            color: #0c5460;
        }
        
        input {
            padding: 8px;
            margin: 5px;
            border: 1px solid #ccc;
            border-radius: 4px;
            width: 200px;
        }
    </style>
</head>
<body>
    <h1>API Debug & Test Tool</h1>
    
    <div class="test-section">
        <h2>1. Backend Verfügbarkeit</h2>
        <button class="test-btn" onclick="testBackendConnection()">Test Backend Connection</button>
        <div id="backend-result"></div>
    </div>
    
    <div class="test-section">
        <h2>2. Login Test</h2>
        <input type="email" id="test-email" placeholder="E-Mail" value="test@example.com">
        <input type="password" id="test-password" placeholder="Passwort" value="password123">
        <br>
        <button class="test-btn" onclick="testLogin()">Test Login</button>
        <div id="login-result"></div>
    </div>
    
    <div class="test-section">
        <h2>3. Token Status</h2>
        <button class="test-btn" onclick="checkTokenStatus()">Check Current Token</button>
        <button class="test-btn" onclick="clearTokens()">Clear All Tokens</button>
        <div id="token-result"></div>
    </div>
    
    <div class="test-section">
        <h2>4. CORS Test</h2>
        <button class="test-btn" onclick="testCORS()">Test CORS Headers</button>
        <div id="cors-result"></div>
    </div>
    
    <div class="test-section">
        <h2>5. Alternative Login-URLs</h2>
        <button class="test-btn" onclick="testAlternativeURLs()">Test Alternative URLs</button>
        <div id="alt-result"></div>
    </div>

    <script>
        const API_BASE = 'https://make-ki-backend-neu-production.up.railway.app';
        
        function log(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            const div = document.createElement('div');
            div.className = `result ${type}`;
            div.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            element.appendChild(div);
        }
        
        function clearLog(elementId) {
            document.getElementById(elementId).innerHTML = '';
        }
        
        async function testBackendConnection() {
            clearLog('backend-result');
            log('backend-result', 'Testing backend connection...', 'info');
            
            try {
                // Test 1: Simple fetch
                const response = await fetch(API_BASE, {
                    method: 'GET',
                    mode: 'cors'
                });
                
                log('backend-result', `Response Status: ${response.status}`, response.ok ? 'success' : 'error');
                log('backend-result', `Response Headers: ${JSON.stringify(Object.fromEntries(response.headers))}`, 'info');
                
                // Test 2: Health check endpoints
                const healthEndpoints = ['/health', '/api/health', '/api/status', '/'];
                
                for (const endpoint of healthEndpoints) {
                    try {
                        const healthResponse = await fetch(API_BASE + endpoint, {
                            method: 'GET',
                            mode: 'cors'
                        });
                        log('backend-result', `${endpoint}: Status ${healthResponse.status}`, healthResponse.ok ? 'success' : 'info');
                    } catch (e) {
                        log('backend-result', `${endpoint}: Failed - ${e.message}`, 'error');
                    }
                }
            } catch (error) {
                log('backend-result', `Connection failed: ${error.message}`, 'error');
            }
        }
        
        async function testLogin() {
            clearLog('login-result');
            const email = document.getElementById('test-email').value;
            const password = document.getElementById('test-password').value;
            
            log('login-result', `Attempting login with: ${email}`, 'info');
            
            const loginUrls = [
                '/api/login',
                '/login',
                '/auth/login',
                '/api/auth/login'
            ];
            
            for (const url of loginUrls) {
                try {
                    log('login-result', `Testing ${API_BASE}${url}`, 'info');
                    
                    const response = await fetch(`${API_BASE}${url}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'application/json'
                        },
                        body: JSON.stringify({ email, password }),
                        mode: 'cors',
                        credentials: 'include'
                    });
                    
                    log('login-result', `Response Status: ${response.status}`, response.ok ? 'success' : 'error');
                    
                    const contentType = response.headers.get('content-type');
                    log('login-result', `Content-Type: ${contentType}`, 'info');
                    
                    if (contentType && contentType.includes('application/json')) {
                        const data = await response.json();
                        log('login-result', `Response: ${JSON.stringify(data, null, 2)}`, response.ok ? 'success' : 'error');
                        
                        if (data.token) {
                            log('login-result', '✓ Token received!', 'success');
                            localStorage.setItem('jwt', data.token);
                            localStorage.setItem('user_email', email);
                        }
                    } else {
                        const text = await response.text();
                        log('login-result', `Response (text): ${text.substring(0, 200)}...`, 'info');
                    }
                    
                    if (response.ok) break;
                    
                } catch (error) {
                    log('login-result', `${url} failed: ${error.message}`, 'error');
                }
            }
        }
        
        function checkTokenStatus() {
            clearLog('token-result');
            
            const token = localStorage.getItem('jwt');
            const email = localStorage.getItem('user_email');
            
            if (token) {
                log('token-result', `Token found: ${token.substring(0, 20)}...`, 'success');
                log('token-result', `Email: ${email}`, 'info');
                
                try {
                    const parts = token.split('.');
                    if (parts.length === 3) {
                        const payload = JSON.parse(atob(parts[1]));
                        log('token-result', `Payload: ${JSON.stringify(payload, null, 2)}`, 'info');
                        
                        if (payload.exp) {
                            const expDate = new Date(payload.exp * 1000);
                            const now = new Date();
                            const isValid = expDate > now;
                            log('token-result', `Expires: ${expDate.toLocaleString()}`, isValid ? 'success' : 'error');
                            log('token-result', `Valid: ${isValid}`, isValid ? 'success' : 'error');
                        }
                    }
                } catch (e) {
                    log('token-result', `Token parsing failed: ${e.message}`, 'error');
                }
            } else {
                log('token-result', 'No token found in localStorage', 'error');
            }
            
            // Check all localStorage keys
            const keys = Object.keys(localStorage);
            log('token-result', `LocalStorage keys: ${keys.join(', ')}`, 'info');
        }
        
        function clearTokens() {
            localStorage.removeItem('jwt');
            localStorage.removeItem('user_email');
            
            const keys = Object.keys(localStorage);
            keys.forEach(key => {
                if (key.startsWith('autosave_form_')) {
                    localStorage.removeItem(key);
                }
            });
            
            log('token-result', 'All tokens and autosave data cleared', 'success');
        }
        
        async function testCORS() {
            clearLog('cors-result');
            
            log('cors-result', 'Testing CORS configuration...', 'info');
            
            try {
                const response = await fetch(`${API_BASE}/api/login`, {
                    method: 'OPTIONS',
                    headers: {
                        'Origin': window.location.origin,
                        'Access-Control-Request-Method': 'POST',
                        'Access-Control-Request-Headers': 'Content-Type'
                    },
                    mode: 'cors'
                });
                
                const headers = {};
                response.headers.forEach((value, key) => {
                    headers[key] = value;
                });
                
                log('cors-result', `CORS Headers: ${JSON.stringify(headers, null, 2)}`, 'info');
                
                if (headers['access-control-allow-origin']) {
                    log('cors-result', '✓ CORS is configured', 'success');
                } else {
                    log('cors-result', '✗ CORS headers missing', 'error');
                }
                
            } catch (error) {
                log('cors-result', `CORS test failed: ${error.message}`, 'error');
            }
        }
        
        async function testAlternativeURLs() {
            clearLog('alt-result');
            
            const alternatives = [
                'https://make-ki-backend-neu-production.up.railway.app',
                'https://make-ki-backend-neu.up.railway.app',
                'https://make-ki-backend.up.railway.app',
                'http://make-ki-backend-neu-production.up.railway.app' // HTTP fallback test
            ];
            
            for (const url of alternatives) {
                try {
                    log('alt-result', `Testing ${url}`, 'info');
                    const response = await fetch(url, {
                        method: 'GET',
                        mode: 'cors'
                    });
                    log('alt-result', `${url}: Status ${response.status}`, response.ok ? 'success' : 'info');
                } catch (e) {
                    log('alt-result', `${url}: ${e.message}`, 'error');
                }
            }
        }
        
        // Auto-run basic test on load
        window.addEventListener('load', () => {
            checkTokenStatus();
        });
    </script>
</body>
</html>