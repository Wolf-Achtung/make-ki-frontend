<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>KI-Readiness ‚Ä¢ PDF Smoke-Test (Option A)</title>
<style>
  :root{--bg:#0b0f14;--card:#141a21;--text:#e6e9ee;--muted:#9aa3ad;--ok:#22c55e;--warn:#f59e0b;--fail:#ef4444;--line:#1f2730}
  *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
  header{padding:16px 20px;background:linear-gradient(90deg,#121820,#11151c);border-bottom:1px solid var(--line)}
  h1{margin:0 0 6px;font-size:18px} .muted{color:var(--muted)}
  main{padding:18px 20px;display:grid;gap:16px;grid-template-columns:repeat(auto-fit,minmax(320px,1fr))}
  section{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:14px}
  h2{margin:0 0 8px;font-size:16px}
  label{display:block;margin:8px 0 4px} input,select,textarea,button{width:100%;padding:8px 10px;border-radius:8px;border:1px solid var(--line);background:#0f141a;color:var(--text)}
  textarea{min-height:160px;font-family:ui-monospace,Menlo,Consolas,monospace}
  button{cursor:pointer} .row{display:flex;gap:8px} .row > *{flex:1}
  .chips{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  .chip{padding:4px 8px;border-radius:999px;border:1px solid var(--line);background:#0f141a}
  .chip.ok{color:var(--ok)} .chip.warn{color:var(--warn)} .chip.fail{color:var(--fail)}
  #log, pre{background:#0f141a;border:1px solid var(--line);border-radius:10px;padding:10px;overflow:auto;white-space:pre-wrap}
  a.btn{display:inline-block;margin-top:8px;padding:8px 10px;border-radius:8px;border:1px solid var(--line);background:#0f141a;color:var(--text);text-decoration:none}
  .hint{font-size:12px;color:var(--muted);margin-top:4px}
</style>
</head>
<body>
<header>
  <h1>KI-Readiness ‚Ä¢ PDF Smoke-Test</h1>
  <div class="muted">Login mit Admin-E-Mail & Passwort ‚Äì Token wird automatisch geholt.</div>
</header>

<main>
  <!-- Direkt: PDF-Service -->
  <section>
    <h2>Direkt: /generate-pdf</h2>
    <label>PDF_SERVICE_URL</label>
    <input id="pdfUrl" value="https://make-ki-pdfservice-production.up.railway.app">
    <label>Empf√§nger-E-Mail (X-User-Email / JSON &quot;to&quot;)</label>
    <input id="userEmail" placeholder="kunde@example.com">
    <div class="row">
      <div>
        <label>Modus</label>
        <select id="payloadMode">
          <option value="auto">auto (text/html ‚Üí JSON-Fallback)</option>
          <option value="html">nur text/html</option>
          <option value="json">nur JSON</option>
        </select>
      </div>
      <div>
        <label>Timeout (Sek.)</label>
        <input id="timeoutSec" type="number" min="5" value="120">
      </div>
    </div>
    <label>HTML-Inhalt</label>
    <textarea id="htmlBody"><!doctype html>
<html><head><meta charset="utf-8"><style>
  body{font-family:Arial,Helvetica,sans-serif;padding:24px} h1{margin:0 0 8px}
  .box{border:1px solid #ddd;border-radius:8px;padding:12px}
</style></head>
<body>
  <h1>Hallo Wolf üëã</h1>
  <div class="box">
   <p>Das ist ein Smoke-Test f√ºr den KI-Readiness PDF-Service.</p>
   <ul>
     <li>Zeit: <script>document.write(new Date().toLocaleString())</script></li>
     <li>Quelle: pdf_smoke_test.html</li>
   </ul>
  </div>
</body></html></textarea>
    <button id="btnDirect">‚û°Ô∏è PDF jetzt erzeugen & herunterladen</button>
    <div id="directResult" class="chips"></div>
    <div><a id="downloadLink" class="btn" href="#" style="display:none">üì• PDF herunterladen</a></div>
    <div class="hint">Tipp: Bei 413/415 bitte im PDF-Service Body-Limit erh√∂hen &amp; JSON akzeptieren.</div>
  </section>

  <!-- Backend: Login + /pdf_test -->
  <section>
    <h2>Backend: Login & /pdf_test</h2>
    <label>Backend-URL</label>
    <input id="backendUrl" value="https://make-ki-backend-neu-production.up.railway.app">
    <div class="row">
      <div>
        <label>Admin-E-Mail</label>
        <input id="adminEmail" placeholder="admin@example.com">
      </div>
      <div>
        <label>Admin-Passwort</label>
        <input id="adminPwd" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
      </div>
    </div>
    <button id="btnLoginAndTest">üîê Login & ‚ñ∂Ô∏è /pdf_test</button>
    <pre id="backendOut" class="muted"></pre>
    <div class="hint">Nutzt /api/login ‚Üí JWT ‚Üí ruft /pdf_test. Keine manuelle Token-Eingabe n√∂tig.</div>
  </section>

  <!-- Async-Flow -->
  <section>
    <h2>Async-Flow: /briefing_async ‚Üí /briefing_status</h2>
    <div class="row">
      <div>
        <label>Sprache</label>
        <select id="lang">
          <option value="de" selected>de</option>
          <option value="en">en</option>
        </select>
      </div>
      <div>
        <label>Unternehmensgr√∂√üe</label>
        <select id="ug">
          <option>kmu</option><option>klein</option><option>solo</option>
        </select>
      </div>
    </div>
    <label>Interesse F√∂rderung</label>
    <select id="foerd"><option>ja</option><option>nein</option><option>unklar</option></select>
    <button id="btnAsync">üèóÔ∏è Login & Flow starten</button>
    <pre id="asyncLog" class="muted"></pre>
  </section>
</main>

<section style="margin:0 20px 20px">
  <h2>Protokoll</h2>
  <pre id="log"></pre>
</section>

<script>
const $ = (id) => document.getElementById(id);
const state = { token: "", lastLoginEmail: "", lastLoginAt: 0 };

const log = (m, lvl="info") => {
  const ts = new Date().toLocaleTimeString();
  $("log").textContent += `[${ts}] ${m}\n`;
};
const chip = (txt, cls="") => `<span class="chip ${cls}">${txt}</span>`;

function makeTimeoutController(sec){
  const ctrl = new AbortController();
  const t = setTimeout(()=>ctrl.abort("timeout"), Math.max(5, sec)*1000);
  return {signal: ctrl.signal, cancel: ()=>clearTimeout(t)};
}

async function doLogin(base, email, pwd){
  const url = base.replace(/\/+$/,"") + "/api/login";
  log(`‚Üí POST ${url}`);
  const r = await fetch(url, {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({ email, password: pwd })
  });
  const js = await r.json().catch(()=>({}));
  if(!r.ok || !js.token){
    log(`‚ùå Login fehlgeschlagen: ${r.status}`);
    throw new Error(js?.detail || "Login fehlgeschlagen");
  }
  state.token = js.token;
  state.lastLoginEmail = email;
  state.lastLoginAt = Date.now();
  log("‚úÖ Login ok");
  return js.token;
}

/* --- Direct PDF --- */
$("btnDirect").onclick = async () => {
  $("directResult").innerHTML = ""; $("downloadLink").style.display="none";
  const base = $("pdfUrl").value.trim().replace(/\/+$/,"");
  const email = $("userEmail").value.trim();
  const mode = $("payloadMode").value;
  const html = $("htmlBody").value;
  const t = makeTimeoutController(parseInt($("timeoutSec").value||"120",10));

  if(!base){ alert("Bitte PDF_SERVICE_URL eintragen."); return; }

  const endpoint = base + "/generate-pdf";
  log(`‚Üí POST ${endpoint} (mode=${mode}) ‚Ä¶`);

  const tryHtml = async () => fetch(endpoint, {
    method:"POST",
    headers: { "Content-Type": "text/html; charset=utf-8", "X-User-Email": email },
    body: new TextEncoder().encode(html),
    signal: t.signal
  });

  const tryJson = async () => fetch(endpoint, {
    method:"POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ html, to: email }),
    signal: t.signal
  });

  try {
    let r;
    if(mode==="html") r = await tryHtml();
    else if(mode==="json") r = await tryJson();
    else {
      r = await tryHtml();
      if(!r.ok){ log(`‚Ä¶ ${r.status} ${r.statusText} (text/html) ‚Äì versuche JSON‚Ä¶`); r = await tryJson(); }
    }

    const ct = r.headers.get("content-type") || "";
    $("directResult").innerHTML = chip(`${r.status} ${r.statusText}`, r.ok ? "ok" : "fail") + chip(ct,"");

    if(!r.ok){
      const txt = await r.text().catch(()=>"(keine Details)");
      log(`‚ùå Antwort: ${r.status} ‚Äì ${txt.substring(0,600)}`);
      return;
    }

    if(ct.includes("application/pdf")){
      const blob = await r.blob();
      const url = URL.createObjectURL(blob);
      const a = $("downloadLink");
      a.href = url; a.download = "KI-Readiness-Report.pdf"; a.style.display="inline-block";
      log(`‚úÖ PDF erhalten (${blob.size} Bytes)`);
    } else {
      const txt = await r.text();
      log(`‚ÑπÔ∏è Keine PDF-Antwort. Inhalt: ${txt.substring(0,600)}`);
    }
  } catch(e){
    log(`‚ùå Fehler beim Fetch: ${e}`);
  } finally {
    t.cancel();
  }
};

/* --- Backend: Login & /pdf_test --- */
$("btnLoginAndTest").onclick = async () => {
  $("backendOut").textContent = "";
  const base = $("backendUrl").value.trim().replace(/\/+$/,"");
  const email = $("adminEmail").value.trim();
  const pwd   = $("adminPwd").value;
  if(!base || !email || !pwd){ alert("Bitte Backend-URL, Admin-E-Mail und Passwort angeben."); return; }
  try{
    const token = await doLogin(base, email, pwd);
    const url = base + "/pdf_test";
    log(`‚Üí POST ${url}`);
    const r = await fetch(url, { method:"POST", headers:{ "Authorization":"Bearer "+token } });
    const js = await r.json().catch(()=>({rawStatus:r.status}));
    $("backendOut").textContent = JSON.stringify(js,null,2);
    log(`‚Ü© ${r.status} /pdf_test`);
  }catch(e){
    $("backendOut").textContent = String(e);
  }
};

/* --- Async Flow (mit Login) --- */
$("btnAsync").onclick = async () => {
  const base = $("backendUrl").value.trim().replace(/\/+$/,"");
  const email = $("adminEmail").value.trim();
  const pwd   = $("adminPwd").value;
  if(!base || !email || !pwd){ alert("Bitte Backend-URL, Admin-E-Mail und Passwort angeben."); return; }

  $("asyncLog").textContent = "";
  const alog = (m)=> $("asyncLog").textContent += m + "\n";

  try{
    const token = state.token && state.lastLoginEmail===email ? state.token : await doLogin(base, email, pwd);

    const startUrl = base + "/briefing_async";
    const statUrl  = base + "/briefing_status/";
    const payload = {
      lang: $("lang").value, language: $("lang").value,
      unternehmensgroesse: $("ug").value,
      interesse_foerderung: $("foerd").value,
      branche: "agentur"
    };

    log(`‚Üí POST ${startUrl}`);
    const r = await fetch(startUrl, {
      method:"POST",
      headers: {"Authorization":"Bearer "+token, "Content-Type":"application/json"},
      body: JSON.stringify(payload)
    });
    const js = await r.json();
    if(!js.job_id){ alog("‚ùå Kein job_id erhalten."); return; }
    alog("job_id: " + js.job_id);

    // Polling
    let done=false, tries=0;
    while(!done && tries<60){
      await new Promise(res=>setTimeout(res, 3000));
      tries++;
      const s = await fetch(statUrl + js.job_id, { headers: {"Authorization":"Bearer "+token} });
      const st = await s.json();
      alog(`[${tries}] ${st.status}  pdf_sent=${st.pdf_sent}  pdf_status=${st.pdf_status||"-"}`);
      if(st.status==="completed" || st.status==="failed"){ done=true; }
    }
  }catch(e){
    alog("‚ùå "+e);
  }
};
</script>
</body>
</html>
