<!DOCTYPE html>
<html lang="de" data-lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Feedback zum KI-Checkup-Report</title>
  <script src="../js/config.js"></script>
  <style>
    :root{ --brand:#1c3763; --bg:#f7fbff; --bd:#dfe9f4; --muted:#5a6b83; }
    body{ max-width:820px; margin:2rem auto; padding:1rem; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; }
    header{ display:flex; justify-content:space-between; align-items:center; gap:1rem; margin-bottom:.5rem; }
    h1{ color:var(--brand); margin:0; }
    .lang{ display:flex; gap:.4rem; }
    .lang button{ border:1px solid var(--bd); background:#fff; border-radius:8px; padding:.35rem .6rem; cursor:pointer; }
    .lang button.active{ background:var(--brand); color:#fff; border-color:var(--brand); }
    p.lead{ color:var(--muted); margin:.35rem 0 1.25rem; }
    .card{ background:#fff; border:1px solid var(--bd); border-radius:12px; padding:1.25rem; margin:1rem 0; }
    label{ display:block; font-weight:600; margin:.75rem 0 .35rem; }
    select, textarea, input[type="text"], input[type="email"] {
      width:100%; padding:.65rem .7rem; border:2px solid var(--bd); border-radius:8px; background:#fff;
    }
    textarea{ min-height:110px; resize:vertical; }
    .muted{ color:var(--muted); font-size:.9rem; }
    .counter{ font-size:.8rem; color:var(--muted); text-align:right; margin-top:.25rem; }
    button{ margin-top:1.2rem; padding:.85rem 1.25rem; font-size:1rem; background:var(--brand); color:#fff; border:none; border-radius:8px; cursor:pointer; }
    button:hover{ filter:brightness(1.05); }
    .req::after{ content:" *"; color:#c00; font-weight:700; }
    .note{ font-size:.85rem; color:var(--muted); margin-top:.25rem; }
  </style>
</head>
<body>

<header>
  <h1>Feedback zum KI-Checkup-Report</h1>
  <div class="lang">
    <span class="muted">Sprache</span>
    <button type="button" id="btn-de" class="active">DE</button>
    <button type="button" id="btn-en">EN</button>
  </div>
</header>
<p class="lead">2 Minuten. Hilft uns, Sprache, Lesefluss und Handlungsempfehlungen weiter zu verbessern.</p>

<form id="feedback-form" class="card" novalidate>
  <input type="hidden" name="email" id="feedback-email"/>
  <input type="hidden" name="variant" id="variant"/>
  <input type="hidden" name="report_version" id="report_version"/>
  <input type="hidden" name="lang_ui" id="lang_ui" value="de"/>
  <input type="hidden" name="timestamp" id="timestamp"/>

  <label for="hilfe" class="req">Wie hilfreich war der KI-Checkup insgesamt?</label>
  <select name="hilfe" id="hilfe" required>
    <option value="">Bitte wählen</option>
    <option>Gar nicht hilfreich</option>
    <option>Eher wenig hilfreich</option>
    <option>Teils/teils</option>
    <option>Ziemlich hilfreich</option>
    <option>Sehr hilfreich</option>
  </select>

  <label for="verstaendlich1" class="req">Wie verständlich sind Analyse & Auswertung?</label>
  <select name="verstaendlich_analyse" id="verstaendlich1" required>
    <option value="">Bitte wählen</option>
    <option>Überhaupt nicht verständlich</option>
    <option>Eher schwer verständlich</option>
    <option>Teils verständlich, teils nicht</option>
    <option>Größtenteils verständlich</option>
    <option>Sehr verständlich</option>
  </select>

  <label for="verstaendlich2" class="req">Sind die Handlungsempfehlungen klar formuliert?</label>
  <select name="verstaendlich_empfehlung" id="verstaendlich2" required>
    <option value="">Bitte wählen</option>
    <option>Überhaupt nicht klar</option>
    <option>Teilweise unklar</option>
    <option>Teils klar, teils unklar</option>
    <option>Größtenteils klar</option>
    <option>Sehr klar und verständlich</option>
  </select>

  <label for="vertrauen" class="req">Wie seriös und vertrauenswürdig wirkt der Report?</label>
  <select name="vertrauen" id="vertrauen" required>
    <option value="">Bitte wählen</option>
    <option>Überhaupt nicht seriös</option>
    <option>Eher wenig seriös</option>
    <option>Mittelmäßig seriös</option>
    <option>Ziemlich seriös</option>
    <option>Sehr seriös und vertrauenswürdig</option>
  </select>

  <label for="dauer" class="req">Wie fandest du den Umfang?</label>
  <select name="dauer" id="dauer" required>
    <option value="">Bitte wählen</option>
    <option>Okay so</option>
    <option>Etwas lang, aber noch akzeptabel</option>
    <option>Viel zu lang</option>
  </select>

  <label for="serio">Was würde dein Vertrauen zusätzlich stärken?</label>
  <textarea name="serio" id="serio" maxlength="1500" placeholder="z. B. mehr Quellenangaben, Benchmarks, Beispiele …"></textarea>
  <div class="counter" data-for="serio"></div>

  <label for="textstellen">Gab es Textstellen, die zu kompliziert, zu lang oder unklar waren?</label>
  <textarea name="textstellen" id="textstellen" maxlength="1500" placeholder="Bitte kurz zitieren oder beschreiben, was genau unklar war …"></textarea>
  <div class="counter" data-for="textstellen"></div>

  <label for="unsicher">Wo wünschst du dir zusätzliche Erklärungen oder Zwischenfragen?</label>
  <textarea name="unsicher" id="unsicher" maxlength="1500" placeholder="z. B. bei der Förderlogik, Roadmap, Tools …"></textarea>
  <div class="counter" data-for="unsicher"></div>

  <label for="features">Welche zusätzlichen Inhalte wären hilfreich (Tabellen, Diagramme, Beispiele …)?</label>
  <textarea name="features" id="features" maxlength="1500" placeholder="Deine Ideen – gerne konkret (wo, was, wozu)"></textarea>
  <div class="counter" data-for="features"></div>

  <label for="freitext">Sonst noch Feedback, Ideen oder Vorschläge?</label>
  <textarea name="freitext" id="freitext" maxlength="1500" placeholder="Alles, was dir noch wichtig ist …"></textarea>
  <div class="counter" data-for="freitext"></div>

  <p id="status" class="muted" aria-live="polite" style="margin-top:.6rem"></p>
  <button type="submit">Feedback absenden</button>
</form>

<script>
(function(){
  function setLang(lang) {
    document.documentElement.dataset.lang = lang;
    document.getElementById("lang_ui").value = lang;
    document.getElementById("btn-de").classList.toggle("active", lang === "de");
    document.getElementById("btn-en").classList.toggle("active", lang === "en");
  }
  document.getElementById("btn-de").addEventListener("click", () => setLang("de"));
  document.getElementById("btn-en").addEventListener("click", () => setLang("en"));

  const API_BASE = window.ENV_BACKEND || 'https://sublime-consideration-production.up.railway.app';
  const form = document.getElementById("feedback-form");
  const statusEl = document.getElementById("status");

  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    const data = Object.fromEntries(new FormData(form).entries());
    if (!data.timestamp) data.timestamp = new Date().toISOString();
    try {
      const res = await fetch(`${API_BASE}/feedback`, {
        method: "POST",
        mode: "cors",
        headers: {
          "Content-Type": "application/json",
          ...(localStorage.getItem("jwt") ? { "Authorization": "Bearer " + localStorage.getItem("jwt") } : {})
        },
        body: JSON.stringify(data)
      });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      statusEl.textContent = "✅ Danke! Feedback gesendet.";
    } catch (err) {
      console.error("Feedback POST failed:", err);
      statusEl.textContent = "❗ Senden fehlgeschlagen – bitte später nochmal.";
    }
  });

  // Prefill from URL/JWT
  const qp = new URLSearchParams(location.search);
  const v = qp.get("variant");
  const rv = qp.get("report_version") || qp.get("version") || qp.get("rv");
  if (v) document.getElementById("variant").value = v;
  if (rv) document.getElementById("report_version").value = rv;
  document.getElementById("timestamp").value = new Date().toISOString();
  try {
    const t = localStorage.getItem("jwt");
    if (t && t.split(".").length === 3) {
      const payload = JSON.parse(atob(t.split(".")[1])); 
      const email = payload.email || payload.sub || null;
      if (email) document.getElementById("feedback-email").value = email;
    }
  } catch(e) {}
})();
</script>

<script>
document.addEventListener("DOMContentLoaded", () => {
  document.querySelectorAll(".counter").forEach(c => {
    const id = c.getAttribute("data-for");
    const el = document.getElementById(id);
    const max = Number(el.getAttribute("maxlength") || 1500);
    const upd = () => c.textContent = `${el.value.length}/${max}`;
    el.addEventListener("input", upd);
    upd();
  });
});
</script>

</body>
</html>
