<!-- filename: formular/index.html -->
<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="robots" content="noindex, nofollow"/>
  <title>Fragebogen – KI-Status-Report</title>
  <style>
    :root { --bg:#f7f9fb; --fg:#0d2b4a; --primary:#003b5a; --muted:#6b7280; }
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial,sans-serif;background:var(--bg);color:var(--fg);margin:0;padding:2rem;line-height:1.5;}
    main{max-width:900px;margin:0 auto;}
    label{display:block;margin-top:1rem;font-weight:600}
    input,select,textarea{width:100%;padding:.7rem;border:1px solid #cbd5e1;border-radius:8px}
    button{background:var(--primary);color:#fff;border:none;border-radius:8px;padding:.8rem 1.2rem;margin-top:1rem;cursor:pointer}
    .muted{color:var(--muted)}
    .result{border:1px solid #cbd5e1;background:#fff;border-radius:12px;margin-top:1rem;padding:1rem}
    .hidden{display:none}
  </style>
  <script src="../js/api.js" defer></script>
</head>
<body>
<main>
  <h1>Fragebogen</h1>
  <p class="muted">Bitte Unternehmen und E‑Mail angeben. Die Auswertung erfolgt im Hintergrund; das Ergebnis erscheint hier automatisch.</p>
  <form id="form">
    <label>Unternehmen
      <input name="company" required/>
    </label>
    <label>E‑Mail
      <input name="email" type="email" required/>
    </label>
    <label>Sprache
      <select name="lang">
        <option value="DE" selected>Deutsch</option>
        <option value="EN">English</option>
      </select>
    </label>
    <label>Notizen (optional)
      <textarea name="notes" rows="4" placeholder="Kontext, Ziele, Besonderheiten…"></textarea>
    </label>
    <button type="submit">Report starten</button>
  </form>

  <div id="progress" class="muted hidden">Report wird erstellt…</div>
  <div id="html" class="result hidden"></div>
  <p id="pdfrow" class="hidden"><button id="pdfbtn">PDF herunterladen</button></p>
</main>

<script>
  const form = document.getElementById('form');
  const progress = document.getElementById('progress');
  const htmlBox = document.getElementById('html');
  const pdfRow = document.getElementById('pdfrow');
  const pdfBtn = document.getElementById('pdfbtn');

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    progress.classList.remove('hidden'); htmlBox.classList.add('hidden'); pdfRow.classList.add('hidden');
    const fd = new FormData(form);
    const payload = {
      lang: fd.get('lang'),
      company: fd.get('company'),
      email: fd.get('email'),
      answers: { notes: fd.get('notes') }
    };
    try {
      const queued = await KIAPI.analyze(payload);
      const id = queued.report_id;
      // poll
      let tries = 0;
      while(tries++ < 60){
        const r = await KIAPI.result(id);
        if (r.status === 'done') {
          progress.classList.add('hidden');
          htmlBox.innerHTML = r.html || '<em>Kein Inhalt erhalten.</em>';
          htmlBox.classList.remove('hidden');
          pdfRow.classList.remove('hidden');
          pdfBtn.onclick = async () => {
            const res = await KIAPI.generatePdf(r.html || '', 'KI-Status-Report.pdf');
            if (res && res.mode === 'fallback' && res.data) {
              const a = document.createElement('a');
              a.href = 'data:text/html;base64,' + res.data;
              a.download = res.filename || 'report.html';
              a.click();
            } else if (res && res.url) {
              window.location.href = res.url;
            } else {
              alert('PDF konnte nicht erstellt werden.');
            }
          };
          return;
        } else if (r.status === 'failed'){
          progress.textContent = 'Fehler bei der Erstellung.';
          return;
        }
        await new Promise(r => setTimeout(r, 1000));
      }
      progress.textContent = 'Timeout beim Warten auf das Ergebnis.';
    } catch(err){
      progress.textContent = 'Fehler: ' + (err && err.message ? err.message : String(err));
    }
  });
</script>
</body>
</html>
