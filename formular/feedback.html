<!DOCTYPE html>
<html lang="de" data-lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="api-base" content="https://api-ki-backend-neu-production.up.railway.app/api">
  <title>Feedback zum KI-Checkup-Report</title>
  <script src="../js/config.js"></script>
  <style>
    :root{ --brand:#1c3763; --bg:#f7fbff; --bd:#dfe9f4; --muted:#5a6b83; --accent:#2563eb; }
    body{ max-width:820px; margin:2rem auto; padding:1rem; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; background:var(--bg); }
    header{ display:flex; justify-content:space-between; align-items:center; gap:1rem; margin-bottom:.5rem; }
    h1{ color:var(--brand); margin:0; font-size:1.6rem; }
    .lang{ display:flex; gap:.4rem; }
    .lang button{ border:1px solid var(--bd); background:#fff; border-radius:8px; padding:.35rem .6rem; cursor:pointer; }
    .lang button.active{ background:var(--brand); color:#fff; border-color:var(--brand); }
    p.lead{ color:var(--muted); margin:.35rem 0 1.25rem; }
    .card{ background:#fff; border:1px solid var(--bd); border-radius:12px; padding:1.25rem; margin:1rem 0; }
    .card h2{ font-size:1.1rem; color:var(--brand); margin:0 0 .75rem; padding-bottom:.5rem; border-bottom:2px solid var(--bd); }
    .card h2 .step{ background:var(--accent); color:#fff; padding:.2rem .5rem; border-radius:6px; font-size:.85rem; margin-right:.5rem; }
    label{ display:block; font-weight:600; margin:.75rem 0 .35rem; color:#1e293b; }
    select, textarea, input[type="text"], input[type="email"] {
      width:100%; padding:.65rem .7rem; border:2px solid var(--bd); border-radius:8px; background:#fff; font-size:1rem;
    }
    select:focus, textarea:focus, input:focus { outline:none; border-color:var(--accent); }
    textarea{ min-height:70px; resize:vertical; }
    .muted{ color:var(--muted); font-size:.9rem; }
    .counter{ font-size:.8rem; color:var(--muted); text-align:right; margin-top:.25rem; }
    .row{ display:grid; grid-template-columns:1fr 1fr; gap:1rem; }
    @media(max-width:600px){ .row{ grid-template-columns:1fr; } }
    button[type="submit"]{ margin-top:1.2rem; padding:.85rem 1.5rem; font-size:1rem; background:var(--accent); color:#fff; border:none; border-radius:8px; cursor:pointer; width:100%; }
    button[type="submit"]:hover{ filter:brightness(1.1); }
    .req::after{ content:" *"; color:#c00; font-weight:700; }
    .note{ font-size:.85rem; color:var(--muted); margin-top:.25rem; }
    .invalid{ border-color:#ef4444!important; background:#fef2f2!important; }
    .success-box{ background:#ecfdf5; border:2px solid #10b981; border-radius:12px; padding:1.5rem; text-align:center; }
    .success-box h3{ color:#047857; margin:0 0 .5rem; }
    .radio-group{ display:flex; flex-wrap:wrap; gap:.5rem; margin-top:.35rem; }
    .radio-group label{ display:flex; align-items:center; gap:.4rem; font-weight:400; padding:.5rem .75rem; background:#f8fafc; border:2px solid var(--bd); border-radius:8px; cursor:pointer; }
    .radio-group label:hover{ background:#f0f9ff; border-color:#93c5fd; }
    .radio-group input[type="radio"]{ margin:0; }
    .radio-group input[type="radio"]:checked + span{ font-weight:600; }
    .radio-group label:has(input:checked){ background:#dbeafe; border-color:var(--accent); }
    .scale-row{ display:flex; justify-content:space-between; gap:.25rem; margin-top:.35rem; }
    .scale-row label{ flex:1; text-align:center; padding:.6rem .25rem; background:#f8fafc; border:2px solid var(--bd); border-radius:8px; cursor:pointer; font-weight:400; font-size:.9rem; }
    .scale-row label:hover{ background:#f0f9ff; border-color:#93c5fd; }
    .scale-row input[type="radio"]{ display:none; }
    .scale-row input[type="radio"]:checked + span{ font-weight:700; color:var(--accent); }
    .scale-row label:has(input:checked){ background:#dbeafe; border-color:var(--accent); }
    .scale-labels{ display:flex; justify-content:space-between; font-size:.8rem; color:var(--muted); margin-top:.25rem; }
    .checkbox-group{ display:flex; flex-wrap:wrap; gap:.5rem; margin-top:.35rem; }
    .checkbox-group label{ display:flex; align-items:center; gap:.4rem; font-weight:400; padding:.5rem .75rem; background:#f8fafc; border:2px solid var(--bd); border-radius:8px; cursor:pointer; }
    .checkbox-group label:hover{ background:#f0f9ff; border-color:#93c5fd; }
    .checkbox-group input[type="checkbox"]{ margin:0; }
    .checkbox-group label:has(input:checked){ background:#dbeafe; border-color:var(--accent); }
  </style>
</head>
<body>

<header>
  <h1>Feedback zum KI-Checkup</h1>
  <div class="lang">
    <span class="muted">Sprache</span>
    <button type="button" id="btn-de" class="active">DE</button>
    <button type="button" id="btn-en">EN</button>
  </div>
</header>
<p class="lead">Ca. 2–3 Minuten. Schnelles Klick-Feedback – hilft uns enorm!</p>

<form id="feedback-form" novalidate>
  <!-- Hidden fields -->
  <input type="hidden" name="email" id="feedback-email"/>
  <input type="hidden" name="variant" id="variant"/>
  <input type="hidden" name="report_version" id="report_version"/>
  <input type="hidden" name="lang_ui" id="lang_ui" value="de"/>
  <input type="hidden" name="timestamp" id="timestamp"/>

  <!-- Block A: Metadaten zum Test -->
  <div class="card">
    <h2><span class="step">A</span>Über Sie & Ihren Test</h2>

    <div class="row">
      <div>
        <label class="req">Unternehmensgröße</label>
        <div class="radio-group">
          <label><input type="radio" name="company_size_feedback" value="solo" required/><span>Solo / Freiberuflich</span></label>
          <label><input type="radio" name="company_size_feedback" value="small_team"/><span>Kleines Team (2–10)</span></label>
          <label><input type="radio" name="company_size_feedback" value="kmu"/><span>KMU (11–100)</span></label>
          <label><input type="radio" name="company_size_feedback" value="larger"/><span>Größer (100+)</span></label>
        </div>
      </div>
      <div>
        <label for="branch_feedback" class="req">Branche</label>
        <select name="branch_feedback" id="branch_feedback" required>
          <option value="">Bitte wählen</option>
          <option value="beratung">Beratung & Dienstleistungen</option>
          <option value="it">IT & Software</option>
          <option value="medien">Medien & Kreativwirtschaft</option>
          <option value="handel">Handel / E-Commerce</option>
          <option value="industrie">Industrie / Produktion</option>
          <option value="sonstige">Sonstige</option>
        </select>
      </div>
    </div>

    <label for="test_reference">Testprofil / Report-Referenz (optional)</label>
    <input type="text" name="test_reference" id="test_reference" placeholder="z. B. Testnummer, Report-ID …" maxlength="100"/>
  </div>

  <!-- Block B: Fragebogen & UX -->
  <div class="card">
    <h2><span class="step">B</span>Fragebogen-Erlebnis</h2>

    <label class="req">Wie verständlich waren die Fragen?</label>
    <div class="scale-row">
      <label><input type="radio" name="ux_clarity_rating" value="1" required/><span>1</span></label>
      <label><input type="radio" name="ux_clarity_rating" value="2"/><span>2</span></label>
      <label><input type="radio" name="ux_clarity_rating" value="3"/><span>3</span></label>
      <label><input type="radio" name="ux_clarity_rating" value="4"/><span>4</span></label>
      <label><input type="radio" name="ux_clarity_rating" value="5"/><span>5</span></label>
    </div>
    <div class="scale-labels"><span>Unklar</span><span>Sehr klar</span></div>

    <label class="req">Wie hoch war der Aufwand insgesamt?</label>
    <div class="scale-row">
      <label><input type="radio" name="ux_effort_rating" value="1" required/><span>1</span></label>
      <label><input type="radio" name="ux_effort_rating" value="2"/><span>2</span></label>
      <label><input type="radio" name="ux_effort_rating" value="3"/><span>3</span></label>
      <label><input type="radio" name="ux_effort_rating" value="4"/><span>4</span></label>
      <label><input type="radio" name="ux_effort_rating" value="5"/><span>5</span></label>
    </div>
    <div class="scale-labels"><span>Wenig Aufwand</span><span>Hoher Aufwand</span></div>

    <label class="req">Pflichtfelder-Umfang</label>
    <div class="radio-group">
      <label><input type="radio" name="ux_required_fields" value="ok" required/><span>Passend</span></label>
      <label><input type="radio" name="ux_required_fields" value="too_many"/><span>Zu viele</span></label>
      <label><input type="radio" name="ux_required_fields" value="too_few"/><span>Zu wenige</span></label>
      <label><input type="radio" name="ux_required_fields" value="unsure"/><span>Kann ich nicht beurteilen</span></label>
    </div>

    <label for="ux_comment">Kurze Ergänzung zum Fragebogen? (optional)</label>
    <textarea name="ux_comment" id="ux_comment" maxlength="500" placeholder="Falls Ihnen etwas aufgefallen ist …"></textarea>
  </div>

  <!-- Block C: Qualität des Reports -->
  <div class="card">
    <h2><span class="step">C</span>Qualität des Reports</h2>

    <label class="req">Wie relevant waren die Empfehlungen?</label>
    <div class="scale-row">
      <label><input type="radio" name="report_relevance_rating" value="1" required/><span>1</span></label>
      <label><input type="radio" name="report_relevance_rating" value="2"/><span>2</span></label>
      <label><input type="radio" name="report_relevance_rating" value="3"/><span>3</span></label>
      <label><input type="radio" name="report_relevance_rating" value="4"/><span>4</span></label>
      <label><input type="radio" name="report_relevance_rating" value="5"/><span>5</span></label>
    </div>
    <div class="scale-labels"><span>Nicht relevant</span><span>Sehr relevant</span></div>

    <label class="req">Haben Sie Ihre Ziele im Report wiedererkannt?</label>
    <div class="scale-row">
      <label><input type="radio" name="report_goals_visible" value="1" required/><span>1</span></label>
      <label><input type="radio" name="report_goals_visible" value="2"/><span>2</span></label>
      <label><input type="radio" name="report_goals_visible" value="3"/><span>3</span></label>
      <label><input type="radio" name="report_goals_visible" value="4"/><span>4</span></label>
      <label><input type="radio" name="report_goals_visible" value="5"/><span>5</span></label>
    </div>
    <div class="scale-labels"><span>Gar nicht</span><span>Sehr gut</span></div>

    <label class="req">Wurden Ihre Leitplanken / No-Gos berücksichtigt?</label>
    <div class="radio-group">
      <label><input type="radio" name="report_guardrails_used" value="yes" required/><span>Ja, berücksichtigt</span></label>
      <label><input type="radio" name="report_guardrails_used" value="no"/><span>Nein, ignoriert</span></label>
      <label><input type="radio" name="report_guardrails_used" value="not_used"/><span>Hatte keine angegeben</span></label>
    </div>

    <label>Was war besonders hilfreich? (Mehrfachauswahl)</label>
    <div class="checkbox-group">
      <label><input type="checkbox" name="report_helpful_sections" value="quick_wins"/><span>Quick Wins</span></label>
      <label><input type="checkbox" name="report_helpful_sections" value="roadmap"/><span>Roadmap</span></label>
      <label><input type="checkbox" name="report_helpful_sections" value="compliance"/><span>Risiko & Compliance</span></label>
      <label><input type="checkbox" name="report_helpful_sections" value="funding"/><span>Fördermöglichkeiten</span></label>
      <label><input type="checkbox" name="report_helpful_sections" value="summary"/><span>Zusammenfassung</span></label>
      <label><input type="checkbox" name="report_helpful_sections" value="other"/><span>Sonstiges</span></label>
    </div>

    <label for="report_comment">Ergänzung zur Report-Qualität? (optional)</label>
    <textarea name="report_comment" id="report_comment" maxlength="500" placeholder="Was war stark, was verbesserungswürdig?"></textarea>
  </div>

  <!-- Block D: Gesamteindruck -->
  <div class="card">
    <h2><span class="step">D</span>Gesamteindruck</h2>

    <label class="req">Wie hilfreich war der KI-Checkup insgesamt?</label>
    <div class="scale-row">
      <label><input type="radio" name="overall_helpfulness_score" value="1" required/><span>1</span></label>
      <label><input type="radio" name="overall_helpfulness_score" value="2"/><span>2</span></label>
      <label><input type="radio" name="overall_helpfulness_score" value="3"/><span>3</span></label>
      <label><input type="radio" name="overall_helpfulness_score" value="4"/><span>4</span></label>
      <label><input type="radio" name="overall_helpfulness_score" value="5"/><span>5</span></label>
      <label><input type="radio" name="overall_helpfulness_score" value="6"/><span>6</span></label>
      <label><input type="radio" name="overall_helpfulness_score" value="7"/><span>7</span></label>
      <label><input type="radio" name="overall_helpfulness_score" value="8"/><span>8</span></label>
      <label><input type="radio" name="overall_helpfulness_score" value="9"/><span>9</span></label>
      <label><input type="radio" name="overall_helpfulness_score" value="10"/><span>10</span></label>
    </div>
    <div class="scale-labels"><span>Nicht hilfreich</span><span>Sehr hilfreich</span></div>

    <label>Würden Sie für so einen Report bezahlen? (optional)</label>
    <div class="radio-group">
      <label><input type="radio" name="payment_willingness" value="no"/><span>Nein</span></label>
      <label><input type="radio" name="payment_willingness" value="lt_100"/><span>Bis ca. 100 €</span></label>
      <label><input type="radio" name="payment_willingness" value="100_250"/><span>100–250 €</span></label>
      <label><input type="radio" name="payment_willingness" value="gt_250"/><span>Mehr als 250 €</span></label>
    </div>

    <label for="final_comment">Sonstige Anmerkungen? (optional)</label>
    <textarea name="final_comment" id="final_comment" maxlength="500" placeholder="Ideen, Kritik, Lob – alles willkommen …"></textarea>
  </div>

  <p id="status" class="muted" aria-live="polite" style="margin-top:.6rem"></p>
  <button type="submit">Feedback absenden</button>
</form>

<div id="success-message" class="card success-box" style="display:none;">
  <h3>Vielen Dank für Ihr Feedback!</h3>
  <p>Ihre Rückmeldung wurde übermittelt und hilft uns, den KI-Checkup weiter zu verbessern.</p>
</div>

<script>
(function(){
  function setLang(lang) {
    document.documentElement.dataset.lang = lang;
    document.getElementById("lang_ui").value = lang;
    document.getElementById("btn-de").classList.toggle("active", lang === "de");
    document.getElementById("btn-en").classList.toggle("active", lang === "en");
  }
  document.getElementById("btn-de").addEventListener("click", () => setLang("de"));
  document.getElementById("btn-en").addEventListener("click", () => setLang("en"));

  const API_BASE = (window.APP_CONFIG && window.APP_CONFIG.API_BASE) || window.ENV_BACKEND || 'https://api-ki-backend-neu-production.up.railway.app/api';
  const form = document.getElementById("feedback-form");
  const statusEl = document.getElementById("status");
  const successBox = document.getElementById("success-message");

  // Validation
  function validateForm() {
    let valid = true;
    const requiredFields = [
      'company_size_feedback', 'branch_feedback',
      'ux_clarity_rating', 'ux_effort_rating', 'ux_required_fields',
      'report_relevance_rating', 'report_goals_visible', 'report_guardrails_used',
      'overall_helpfulness_score'
    ];

    // Reset invalid states
    form.querySelectorAll('.invalid').forEach(el => el.classList.remove('invalid'));

    requiredFields.forEach(name => {
      const el = form.querySelector(`[name="${name}"]`);
      if (!el) return;

      let hasValue = false;
      if (el.type === 'radio') {
        hasValue = form.querySelector(`[name="${name}"]:checked`) !== null;
      } else {
        hasValue = el.value.trim() !== '';
      }

      if (!hasValue) {
        valid = false;
        if (el.type === 'radio') {
          const container = el.closest('.scale-row') || el.closest('.radio-group');
          if (container) container.classList.add('invalid');
        } else {
          el.classList.add('invalid');
        }
      }
    });

    return valid;
  }

  form.addEventListener("submit", async (e) => {
    e.preventDefault();

    if (!validateForm()) {
      statusEl.textContent = "Bitte füllen Sie die markierten Pflichtfelder aus.";
      const firstInvalid = form.querySelector('.invalid');
      if (firstInvalid) firstInvalid.scrollIntoView({ behavior: 'smooth', block: 'center' });
      return;
    }

    // Collect form data including checkbox arrays
    const formData = new FormData(form);
    const data = {};

    formData.forEach((value, key) => {
      if (data[key]) {
        // Handle multiple values (checkboxes)
        if (Array.isArray(data[key])) {
          data[key].push(value);
        } else {
          data[key] = [data[key], value];
        }
      } else {
        data[key] = value;
      }
    });

    if (!data.timestamp) data.timestamp = new Date().toISOString();

    try {
      statusEl.textContent = "Wird gesendet …";
      const res = await fetch(`${API_BASE}/feedback`, {
        method: "POST",
        mode: "cors",
        credentials: "include",
        headers: {
          "Content-Type": "application/json",
          ...(localStorage.getItem("jwt") ? { "Authorization": "Bearer " + localStorage.getItem("jwt") } : {})
        },
        body: JSON.stringify(data)
      });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);

      // Show success message
      form.style.display = 'none';
      successBox.style.display = 'block';
      successBox.scrollIntoView({ behavior: 'smooth', block: 'start' });
    } catch (err) {
      console.error("Feedback POST failed:", err);
      statusEl.textContent = "❗ Senden fehlgeschlagen – bitte später nochmal versuchen.";
    }
  });

  // Prefill from URL/JWT
  const qp = new URLSearchParams(location.search);
  const v = qp.get("variant");
  const rv = qp.get("report_version") || qp.get("version") || qp.get("rv");
  const emailParam = qp.get("email");
  if (v) document.getElementById("variant").value = v;
  if (rv) document.getElementById("report_version").value = rv;
  document.getElementById("timestamp").value = new Date().toISOString();

  // Email aus URL-Parameter auslesen und Felder füllen
  if (emailParam) {
    const decodedEmail = decodeURIComponent(emailParam);
    document.getElementById("feedback-email").value = decodedEmail;
    document.getElementById("test_reference").value = decodedEmail;
  }

  // Fallback: Email aus JWT holen (falls nicht in URL)
  if (!emailParam) {
    try {
      const t = localStorage.getItem("jwt");
      if (t && t.split(".").length === 3) {
        const payload = JSON.parse(atob(t.split(".")[1]));
        const email = payload.email || payload.sub || null;
        if (email) document.getElementById("feedback-email").value = email;
      }
    } catch(e) {}
  }
})();
</script>

</body>
</html>
