<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Zahlung Debug</title>
  <style>
    body { font-family: sans-serif; margin: 2rem; }
    .error { color: red; margin-top: 1rem; }
    .log { background: #eee; padding: 1rem; margin-top: 1rem; white-space: pre-wrap; font-family: monospace; }
    button { margin-top: 1rem; padding: 0.75rem 1.5rem; font-size: 1rem; }
  </style>
</head>
<body>
  <h1>üí≥ Zahlung abschlie√üen (Debug)</h1>
  <p>Sie erhalten nach dem Klick eine PDF-Erstellung, eine E-Mail und eine Weiterleitung zur Danke-Seite.</p>
  <button onclick="completePayment()">Bezahlung abschlie√üen</button>

  <div class="error" id="error"></div>
  <div class="log" id="log"></div>

  <script>
    async function completePayment() {
      const resultRaw = sessionStorage.getItem("kiCheckResult");
      const email = sessionStorage.getItem("email") || "";
      const errorBox = document.getElementById("error");
      const logBox = document.getElementById("log");

      errorBox.textContent = "";
      logBox.textContent = `‚ñ∂Ô∏è Email: ${email}\n‚ñ∂Ô∏è KI-Ergebnis (roh):\n${resultRaw}`;

      if (!resultRaw || !email) {
        errorBox.textContent = "‚ùå Fehler: Keine Analyse-Daten oder E-Mail gefunden.";
        return;
      }

      let result;
      try {
        result = JSON.parse(resultRaw);
      } catch (e) {
        errorBox.textContent = "‚ùå JSON-Parsing fehlgeschlagen.";
        return;
      }

      try {
        const res = await fetch("https://make-ki-backend-production.up.railway.app/generate-pdf", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ values: result })
        });

        const data = await res.json();
        if (!res.ok || !data.pdf_url) throw new Error("PDF-Erstellung fehlgeschlagen");

        logBox.textContent += `\n\n‚úÖ PDF-Link: ${data.pdf_url}`;

        await fetch("https://hook.eu2.make.com/8tihhrgevougjt8ljm6fb9ony7upnryh", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ email: email, pdf_url: data.pdf_url })
        });

        window.location.href = "/formular/danke.html";
      } catch (err) {
        console.error("Fehler bei der Ausf√ºhrung:", err);
        errorBox.textContent = "‚ùå Fehler bei PDF oder Versand: " + err.message;
      }
    }
  </script>
</body>
</html>
